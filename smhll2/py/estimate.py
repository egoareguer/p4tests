#!/usr/bin/python
import os
import scipy.integrate as integrate
import scipy.special as special
from numpy import log, inf, inf

#Reminder: With m substreams,
# 	   E = alpha(m)*m*m*(sum (i->m) [ 2^( - max (zeroes) ) ] ) 
#    With: alpha(m) = m / (integrate (0 -> infinite) [ ( log2((2+u)/(1+u)) )^m ] du )   
#    Suggested alpha values:
#	alpha (16) = 0.673
#	alpha (32) = 0.697 
#	alpha (64) = 0.709 
#	alpha (m)  = 0.7213/(1+1.079/m) for m >= 128

p=8
m=2**p

def calc_alpha(m): #Single call, can be substituted on compilation to insert alpha's value in the p4 program
	if   m == 16:
		return 0.673
	elif m == 32:
		return 0.697
	elif m == 64:
		return 0.709
	else:
		def integrand(u,m):
			return  ( log ((2+u)/(1+u))/ log(2) )**m 
		integrale = integrate.quad(integrand, 0, +inf, args=(m))
		print("alpha:", 1/(m*integrale[0]))
		return(1/(m*integrale[0]))

def calc_estimate(m,zeroes):
	alpha=calc_alpha(m)
#	if last_m!=m:
#		alpha = calc_alpha(m)
#		last_m=m
	s=0
	for i in range(m):
		s=s+2**(-(zeroes[i])) 
	res=alpha*m*m/sum
	print("sum:",sum, "m:",m)
	return(res,alpha)

def calc_blocks(f,m,tab):
	res_list=[]
	#f how many flows are in tab
	#m how many entries each HLL struct has
	alpha=calc_alpha(m)
	for i in range(f):
		s=0
		for j in range(m):
			s=s+2**(-tab[i*m+j])
		res=alpha*m*m*s
		res_list.append(res)
	print(res_list)

#srcIP_masterReg= [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 2, 1, 0, 1, 4, 1, 0, 0, 0, 0, 0, 2, 0, 0, 3, 0, 0, 1, 8, 0, 0, 2, 0, 0, 1, 2, 1, 0, 0, 5, 1, 1, 0, 0, 0, 2, 4, 5, 2, 0, 6, 3, 3, 0, 1, 0, 0, 0, 0, 1, 0, 2, 0, 0, 1, 1, 2, 2, 0, 0, 3, 1, 2, 0, 0, 0, 0, 2, 0, 1, 5, 2, 2, 1, 1, 0, 2, 0, 1, 3, 0, 4, 4, 4, 1, 3, 3, 2, 0, 2, 3, 1, 0, 0, 2, 2, 2, 0, 1, 1, 3, 0, 2, 0, 0, 2, 1, 0, 1, 5, 1, 0, 2, 3, 4, 4, 1, 0, 1, 2, 1, 6, 2, 1, 4, 2, 3, 2, 2, 1, 0, 4, 4, 0, 2, 0, 0, 3, 0, 0, 4, 2, 2, 0, 15, 0, 4, 0, 2, 2, 2, 4, 1, 0, 1, 1, 4, 1, 2, 0, 3, 1, 4, 0, 1, 3, 5, 3, 3, 4, 3, 2, 0, 1, 4, 1, 1, 4, 1, 1, 2, 3, 4, 1, 2, 5, 4, 4, 7, 1, 4, 5, 1, 6, 1, 1, 1, 2, 2, 2, 2, 2, 2, 1, 0, 2, 8, 4, 3, 5, 1, 5, 1, 3, 7, 1, 1, 3, 3, 1, 2, 6, 4, 0, 2, 2, 1, 3, 6, 3, 3, 1, 1, 1, 9, 1, 4, 3, 1, 5, 7, 0, 1, 5, 1, 2, 1, 2, 1, 3, 8, 2, 3, 7, 3, 1, 3, 3, 0, 4, 9, 2, 3, 1, 2, 4, 3, 0, 2, 2, 2, 1, 3, 5, 2, 2, 4, 2, 3, 3, 1, 1, 1, 5, 2, 2, 4, 0, 4, 4, 2, 6, 2, 5, 2, 2, 1, 2, 3, 2, 5, 2, 2, 2, 2, 2, 2, 4, 2, 1, 5, 1, 4, 8, 2, 1, 2, 3, 2, 4, 1, 2, 1, 3, 3, 4, 2, 3, 4, 0, 8, 2, 4, 6, 5, 2, 2, 2, 4, 4, 3, 3, 1, 7, 7, 4, 3, 3, 3, 3, 9, 4, 2, 4, 2, 2, 4, 1, 2, 1, 2, 1, 2, 7, 1, 3, 3, 8, 2, 3, 3, 3, 3, 2, 4, 3, 3, 1, 2, 7, 5, 2, 3, 6, 2, 2, 1, 3, 3, 4, 3, 4, 3, 4, 7, 6, 2, 2, 7, 6, 1, 1, 4, 3, 1, 3, 2, 2, 5, 3, 4, 2, 2, 8, 1, 2, 3, 2, 4, 4, 6, 7, 4, 3, 3, 3, 3, 1, 4, 2, 1, 3, 2, 4, 1, 7, 1, 2, 3, 4, 4, 6, 3, 3, 2, 3, 3, 4, 2, 4, 3, 3, 4, 6, 8, 5, 3, 4, 10, 3, 4, 6, 3, 4, 2, 4, 3, 4, 2, 2, 5, 4, 3, 4, 3, 6, 3, 3, 5, 4, 3, 8, 3, 10, 5, 3, 5, 2, 5, 5, 6, 2, 2, 7, 6, 1, 4, 4, 5, 3, 1, 6, 2, 4, 3, 2, 2, 4, 3, 3, 3, 9, 5, 3, 2, 1, 3, 4, 6, 10, 9, 5, 3, 1, 4, 3, 7, 1, 3, 13, 3, 2, 4, 4, 10, 5, 6, 3, 7, 7, 6, 2, 5, 2, 2, 3, 2, 3, 9, 1, 2, 3, 5, 3, 3, 2, 3, 3, 4, 4, 3, 4, 3, 2, 1, 4, 8, 5, 5, 6, 8, 4, 3, 3, 4, 2, 3, 4, 5, 2, 2, 3, 5, 3, 7, 6, 4, 8, 2, 2, 4, 2, 3, 6, 8, 4, 4, 4, 1, 3, 2, 1, 6, 4, 7, 3, 4, 5, 6, 4, 3, 6, 3, 3, 2, 4, 3, 5, 4, 3, 3, 5, 7, 5, 8, 5, 5, 5, 3, 2, 3, 3, 6, 3, 5, 4, 4, 3, 7, 5, 2, 4, 5, 1, 2, 2, 2, 6, 2, 3, 4, 4, 5, 4, 2, 3, 4, 5, 2, 2, 4, 2, 7, 4, 3, 2, 6, 3, 3, 4, 1, 6, 3, 6, 7, 5, 4, 4, 3, 3, 4, 3, 2, 3, 3, 11, 7, 3, 6, 2, 7, 2, 4, 4, 4, 1, 6, 2, 2, 3, 7, 3, 8, 2, 2, 11, 5, 7, 4, 2, 3, 3, 1, 4, 5, 17, 5, 2, 4, 5, 5, 1, 8, 5, 4, 3, 2, 4, 3, 2, 3, 2, 7, 3, 6, 4, 7, 2, 2, 2, 4, 4, 8, 2, 4, 7, 1, 4, 4, 5, 7, 3, 3, 7, 7, 3, 9, 5, 3, 7, 4, 5, 2, 4, 7, 2, 3, 2, 11, 5, 1, 4, 4, 2, 3, 4, 8, 5, 4, 6, 4, 2, 4, 6, 5, 8, 5, 5, 6, 2, 4, 4, 6, 4, 6, 4, 3, 3, 6, 4, 1, 7, 2, 4, 5, 7, 5, 2, 10, 2, 2, 4, 2, 7, 6, 3, 6, 3, 7, 3, 2, 8, 3, 6, 4, 3, 4, 5, 3, 14, 1, 3, 3, 3, 4, 2, 6, 9, 4, 2, 6, 3, 1, 4, 4, 11, 7, 6, 3, 3, 6, 6, 5, 3, 4, 8, 4, 5, 9, 3, 2, 3, 9, 8, 4, 4, 8, 4, 6, 8, 5, 3, 7, 5, 4, 4, 3, 4, 3, 3, 2, 6, 6, 2, 3, 4, 3, 4, 5, 5, 6, 9, 7, 4, 6, 3, 7, 4, 5, 3, 7, 4, 2, 9, 2, 5, 4, 6, 2, 6, 4, 2, 3, 4, 5, 2, 9, 3, 3, 6, 8, 6, 8, 4, 5, 3, 2, 3, 5, 4, 3, 9, 6, 5, 6, 6, 2, 5, 7, 4, 6, 2, 7, 2, 2, 6, 2, 8, 4, 2, 4, 5, 3, 4, 5, 4, 4, 4, 5, 4, 5, 3, 5, 3, 7, 6, 3, 5, 6, 5, 4, 8, 7, 3, 4, 4, 8]

#srcIP_masterReg=[ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 4, 0, 0, 0, 0, 3, 0, 3, 3, 5, 0, 0, 1, 7, 3, 5, 1, 1, 2, 0, 4, 0, 2, 1, 0, 1, 0, 3, 1, 1, 1, 0, 7, 0, 3, 2, 0, 3, 2, 3, 1, 3, 0, 4, 1, 1, 7, 1, 3, 4, 3, 4, 3, 3, 2, 4, 2, 1, 1, 2, 6, 2, 4, 3, 4, 2, 2, 3, 2, 3, 2, 1, 3, 4, 1, 2, 2, 3, 2, 2, 1, 4, 1, 0, 1, 0, 1, 3, 1, 3, 3, 2, 1, 1, 3, 1, 3, 1, 8, 6, 4, 4, 8, 7, 3, 2, 3, 6, 0, 2, 2, 2, 1, 3, 1, 2, 2, 4, 3, 3, 1, 1, 3, 7, 7, 3, 2, 4, 3, 3, 1, 10, 5, 3, 2, 4, 4, 2, 2, 6, 2, 2, 3, 3, 3, 2, 2, 2, 5, 5, 2, 3, 1, 3, 2, 4, 3, 3, 3, 3, 4, 5, 2, 5, 9, 4, 3, 2, 3, 3, 3, 9, 6, 2, 4, 6, 2, 6, 3, 2, 3, 2, 3, 2, 4, 2, 3, 6, 7, 2, 3, 5, 3, 5, 6, 5, 2, 5, 4, 5, 3, 3, 2, 2, 3, 3, 4, 3, 3, 7, 6, 2, 4, 8, 6, 3, 3, 8, 2, 2, 5, 2, 3, 2, 4, 4, 5, 5, 2, 3, 4, 3, 9, 3, 5, 1, 4, 2, 2, 11, 3, 6, 2, 4, 2, 2, 2, 4, 2, 4, 8, 4, 1, 10, 2, 4, 3, 5, 2, 5, 6, 3, 3, 7, 1, 5, 3, 5, 5, 4, 4, 6, 2, 2, 8, 5, 3, 4, 3, 4, 3, 4, 3, 6, 8, 9, 7, 3, 2, 3, 4, 5, 2, 3, 6, 3, 4, 5, 4, 2, 4, 5, 2, 4, 7, 10, 3, 4, 5, 5, 9, 6, 5, 8, 7, 3, 4, 7, 2, 2, 5, 5, 4, 5, 3, 5, 4, 5, 5, 4, 6, 3, 4, 6, 2, 3, 4, 3, 4, 3, 3, 2, 3, 2, 3, 5, 4, 5, 5, 4, 9, 4, 6, 4, 6, 5, 3, 5, 8, 6, 3, 6, 4, 6, 10, 6, 5, 4, 4, 3, 4, 6, 6, 6, 4, 3, 4, 3, 3, 3, 4, 3, 4, 3, 7, 4, 8, 5, 4, 3, 5, 6, 7, 3, 3, 5, 5, 3, 5, 3, 3, 4, 9, 4, 3, 7, 3, 7, 3, 7, 6, 4, 5, 4, 4, 6, 7, 6, 3, 5, 5, 5, 5, 3, 5, 6, 6, 8, 4, 4, 4, 4, 7, 3, 4, 8, 7, 4, 9, 12, 2, 3, 9, 3, 5, 4, 4, 4, 2, 4, 5, 5, 6, 11, 11, 7, 5, 9, 6, 5, 4, 5, 5, 4, 4, 5, 3, 4, 5, 5, 5, 6, 4, 4, 3, 8, 6, 5, 4, 6, 4, 10, 3, 5, 4, 7, 5, 4, 5, 7, 4, 2, 3, 4, 4, 5, 6, 6, 3, 5, 3, 5, 5, 4, 3, 7, 4, 6, 6, 4, 4, 9, 5, 6, 4, 6, 5, 4, 4, 6, 11, 8, 7, 3, 6, 6, 5, 5, 7, 6, 5, 7, 4, 5, 4, 5, 5, 4, 5, 4, 5, 4, 5, 5, 5, 5, 7, 5, 3, 4, 4, 3, 5, 8, 6, 6, 5, 4, 3, 5, 9, 6, 6, 8, 6, 4, 13, 4, 4, 7, 5, 3, 5, 7, 2, 4, 5, 4, 4, 6, 5, 5, 5, 6, 6, 5, 3, 3, 4, 6, 7, 6, 6, 6, 5, 4, 5, 2, 5, 8, 6, 4, 8, 7, 6, 5, 2, 7, 5, 4, 4, 5, 4, 3, 5, 5, 6, 8, 11, 6, 4, 5, 9, 5, 4, 6, 11, 8, 5, 5, 6, 6, 7, 7, 5, 7, 9, 4, 8, 8, 6, 6, 6, 6, 5, 4, 9, 6, 8, 5, 3, 7, 5, 5, 7, 6, 10, 4, 6, 5, 4, 5, 4, 6, 5, 4, 3, 5, 6, 5, 5, 5, 4, 4, 6, 8, 3, 8, 5, 4, 7, 5, 5, 4, 4, 6, 4, 3, 9, 8, 5, 9, 3, 4, 8, 6, 6, 5, 7, 6, 4, 7, 5, 6, 3, 5, 5, 7, 3, 7, 5, 7, 8, 6, 5, 4, 7, 5, 5, 3, 5, 5, 4, 5, 4, 7, 7, 4, 6, 7, 5, 4, 12, 7, 6, 4, 7, 6, 3, 10, 9, 6, 5, 6, 5, 7, 7, 6, 7, 5, 5, 5, 6, 11, 9, 8, 8, 4, 10, 8, 6, 7, 10, 3, 4, 6, 5, 5, 4, 6, 5, 5, 6, 4, 4, 6, 5, 4, 5, 7, 5, 6, 4, 8, 8, 4, 5, 4, 5, 5, 7, 6, 9, 10, 5, 7, 5, 6, 5, 5, 7, 7, 5, 5, 6, 4, 4, 7, 6, 5, 6, 6, 8, 7, 5, 3, 7, 5, 4, 6, 5, 6, 9, 4, 7, 4, 6, 6, 5, 5, 6, 6, 9, 10, 4, 6, 7, 9, 6, 9, 5, 4, 6, 6, 5, 8, 5, 2, 4, 7, 6, 7, 5, 13, 4, 5, 3, 8, 6, 7, 6, 6, 6, 9, 5, 6, 5, 8, 8, 7, 11, 5, 5, 6, 6, 6, 6, 3, 7, 4, 7, 6, 10, 3, 6, 4, 4, 6, 5, 6, 6, 4, 8, 3, 5, 6, 7, 10, 6, 5, 7, 9, 4, 5, 8, 4, 8, 7, 9, 11, 7, 5, 7, 7, 5, 5, 4, 10, 2, 10, 4, 5, 9, 6, 5, 4, 5, 13, 6, 5, 5, 5, 6, 8, 5, 6, 5, 8, 5, 4, 4, 5, 4, 7, 3, 5, 7, 5, 5, 5, 8, 7, 8, 6, 3, 4, 5, 6, 7, 6, 5, 5, 5, 7, 6, 5, 7, 8, 5, 9, 11, 5, 6, 4, 7, 5, 4, 4, 5, 7, 4, 4, 4, 5, 6, 5, 8]

srcIP_masterReg=[ 1, 3, 1, 5, 3, 1, 5, 1, 5, 1, 3, 1, 1, 5, 1, 3, 1, 2, 1, 2, 2, 1, 3, 0, 2, 1, 2, 1, 1, 2, 1, 0, 1, 3, 1, 5, 3, 1, 5, 1, 5, 1, 3, 1, 1, 5, 1, 3, 1, 2, 1, 3, 5, 1, 3, 1, 3, 1, 5, 1, 1, 3, 1, 5, 1, 3, 1, 5, 3, 1, 5, 1, 5, 1, 3, 1, 1, 5, 1, 3, 1, 2, 1, 3, 5, 1, 3, 1, 3, 1, 5, 1, 1, 3, 1, 5, 1, 3, 1, 6, 3, 1, 6, 1, 6, 1, 3, 1, 1, 6, 1, 3, 1, 11, 1, 3, 8, 1, 3, 1, 3, 1, 7, 1, 1, 3, 1, 5, 1, 3, 1, 6, 3, 1, 6, 1, 6, 1, 3, 1, 1, 6, 1, 3, 1, 11, 1, 3, 8, 1, 3, 1, 3, 1, 7, 1, 1, 3, 1, 7, 3, 3, 4, 6, 3, 3, 6, 4, 6, 4, 3, 3, 4, 6, 3, 3, 4, 11, 3, 3, 8, 4, 3, 3, 3, 3, 7, 4, 3, 3, 4, 7, 3, 3, 7, 6, 3, 3, 6, 7, 6, 8, 3, 3, 11, 6, 3, 3, 6, 11, 3, 3, 8, 6, 3, 3, 3, 3, 7, 6, 3, 3, 6, 7, 2, 4, 2, 6, 4, 2, 6, 2, 6, 2, 4, 2, 2, 6, 2, 4, 5, 11, 3, 4, 8, 5, 4, 3, 8, 3, 7, 5, 3, 10, 5, 7, 1, 6, 1, 6, 6, 1, 6, 1, 6, 1, 6, 1, 1, 6, 1, 6, 1, 11, 1, 7, 8, 1, 7, 1, 5, 1, 7, 1, 1, 5, 1, 7, 4, 3, 3, 7, 3, 4, 7, 3, 8, 3, 3, 4, 3, 11, 4, 3, 3, 11, 4, 3, 8, 3, 3, 4, 3, 4, 7, 4, 4, 3, 4, 7, 6, 10, 3, 6, 8, 6, 6, 3, 6, 4, 7, 6, 4, 6, 6, 7, 4, 11, 7, 6, 8, 4, 6, 7, 6, 8, 7, 4, 10, 6, 4, 7, 3, 5, 6, 6, 5, 3, 6, 6, 6, 6, 4, 3, 6, 6, 3, 5, 11, 11, 3, 4, 8, 8, 4, 3, 4, 3, 7, 7, 3, 4, 7, 7, 8, 3, 4, 6, 3, 9, 6, 4, 6, 4, 3, 7, 4, 6, 7, 3, 4, 11, 6, 3, 8, 4, 3, 6, 3, 6, 7, 4, 6, 3, 4, 7, 4, 3, 4, 6, 3, 4, 6, 7, 6, 4, 3, 4, 4, 6, 4, 3, 4, 11, 3, 3, 9, 4, 3, 3, 3, 3, 7, 4, 3, 3, 4, 7, 3, 5, 7, 6, 5, 3, 6, 7, 6, 9, 6, 3, 11, 6, 3, 5, 6, 11, 3, 5, 8, 6, 5, 3, 5, 3, 7, 6, 3, 5, 6, 7, 3, 6, 7, 6, 6, 3, 6, 7, 6, 11, 6, 3, 11, 6, 3, 6, 6, 11, 3, 7, 8, 6, 7, 3, 10, 3, 7, 6, 3, 8, 6, 7, 8, 4, 7, 6, 4, 10, 6, 7, 6, 8, 4, 7, 11, 6, 7, 4, 6, 11, 6, 4, 8, 6, 4, 6, 5, 6, 7, 6, 6, 5, 6, 7, 3, 9, 7, 6, 8, 3, 6, 7, 6, 8, 7, 3, 11, 6, 3, 7, 6, 11, 3, 6, 11, 6, 6, 3, 6, 3, 7, 6, 3, 6, 6, 7, 3, 4, 7, 7, 4, 3, 7, 7, 8, 8, 4, 3, 11, 9, 3, 3, 9, 11, 7, 3, 8, 8, 3, 7, 3, 3, 7, 7, 3, 3, 7, 7, 6, 4, 7, 6, 4, 6, 6, 7, 6, 8, 4, 6, 11, 6, 6, 4, 7, 11, 5, 4, 8, 7, 4, 5, 3, 8, 7, 9, 9, 4, 8, 7, 6, 7, 7, 8, 7, 6, 9, 7, 7, 8, 9, 6, 11, 7, 6, 8, 6, 11, 8, 6, 8, 6, 6, 9, 6, 7, 7, 6, 7, 6, 6, 7, 3, 6, 15, 6, 6, 3, 6, 8, 6, 8, 6, 3, 11, 6, 3, 6, 6, 11, 3, 10, 8, 6, 8, 3, 7, 3, 7, 6, 3, 7, 6, 7, 7, 4, 7, 6, 4, 7, 6, 7, 6, 8, 4, 8, 11, 6, 10, 4, 6, 11, 6, 4, 8, 6, 4, 6, 8, 6, 8, 6, 6, 10, 6, 12, 7, 6, 7, 6, 5, 7, 6, 7, 6, 8, 6, 8, 11, 6, 9, 6, 6, 11, 6, 7, 8, 6, 7, 6, 8, 6, 7, 6, 6, 10, 6, 7, 6, 3, 9, 6, 6, 6, 6, 8, 6, 8, 6, 6, 11, 6, 6, 6, 6, 11, 8, 9, 8, 6, 8, 10, 7, 7, 7, 6, 7, 7, 6, 7, 5, 7, 6, 8, 7, 5, 16, 6, 7, 6, 10, 5, 6, 7, 5, 8, 7, 6, 5, 6, 6, 7, 6, 5, 6, 6, 6, 12, 5, 6, 8, 6, 7, 4, 10, 6, 4, 7, 6, 8, 6, 7, 4, 8, 7, 6, 11, 4, 6, 7, 6, 4, 7, 6, 4, 6, 3, 4, 8, 6, 6, 3, 6, 10, 6, 6, 3, 8, 6, 6, 9, 3, 7, 3, 6, 6, 3, 7, 6, 6, 3, 6, 8, 11, 6, 3, 8, 9, 7, 7, 6, 3, 7, 7, 3, 6, 3, 7, 6, 3, 7, 3, 3, 6, 3, 6, 11, 3, 6, 3, 3, 8, 7, 3, 3, 6, 3, 7, 6, 3, 6, 3, 3, 9, 3, 6, 8, 3, 6, 3, 9, 8, 3, 6, 10, 8, 7, 7, 3, 6, 7, 7, 6, 3, 7, 6, 8, 3, 6, 7, 3, 11, 3, 7, 6, 10, 7, 3, 8, 6, 7, 6, 4, 6, 6, 7, 6, 4, 6, 4, 6, 8, 4, 6, 9, 6, 4, 7, 6, 9, 7, 4, 8, 6, 7, 6, 8, 4, 6, 7, 4, 9, 4, 6, 7, 6, 6, 4, 6, 7, 6, 9, 6, 4, 8, 6, 4, 6, 6, 8, 6, 7, 9, 6, 7, 6, 9, 6, 7, 6, 6, 8, 6, 7]


calc_blocks(31,32,srcIP_masterReg)
